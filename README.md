# Code and notebooks for external corrosion (EC) model performance

For background of EC model performance metric see [this doc](https://pge-my.sharepoint.com/:w:/p/a1yu/EVBCjNZdJaRCtieaU4lQJHQBtHOZy5lf0-Ut-y5igNEHZg), for implementation approach see [this doc](https://pge-my.sharepoint.com/:w:/p/a1yu/EfobQEi_deVBqQ_aCYOyUUgBCuQU4wNKtz6y32zTly181A).

## Notebooks:

[segmenting_ILI_excel_sheet](./segmenting_ILI_excel_sheet.ipynb): Notebook to extract a certain year's ILI tally rows from the consodliated `All_ILIData.csv` file. While this can be done easily from Foundry, we can only download 10k rows at a time (if have access). So before migrating all workflows into Foundry, using this notebook to extract ILI data is much faster.
- By default it saves the extraction of a certain year's data as `cleaned_ILI_<year>.csv`. I usually move it to `./processed_data` folder.

[EC_and_ILI_v0](./EC_and_ILI_v0.ipynb): First draft of performance measurement via correlation between ILI failure pressure and EC_LOF values. Here I try to directly access the EC_LOF risk values through direct connection to MarinerDB. This doesn't work too well because we can't easily map the ILI anomalies spatially to the pipe segments in the risk model.

[EC_LOF_performance_measurement_2021](./EC_LOF_performance_measurement_2021.ipynb), [EC_LOF_performance_measurement_2022](./EC_LOF_performance_measurement_2022.ipynb): Version 1 of performance measurement via correlation apporach. Separate notebooks for each year, they are largely the same with minor data handling differences. Have yet to generalize them (since only two instances so far, based on availability of MarinerDB results). Several big differences here compared to v0:
- The EC_LOF table is spatial-joined to ILI data (details see [notes](https://pge-my.sharepoint.com/:w:/p/a1yu/EfobQEi_deVBqQ_aCYOyUUgBCuQU4wNKtz6y32zTly181A)), this way for each ILI anomaly value, it's assigned the LOF values of the corresponding risk model dynamic segment (defined by `beginstationseriesid`, `beginstationnum`, `endstationnum`).
- The correlation is performed on dynamic segment level -- the failure pressures of all anomalies on the same dynamic segment are aggregated via `mean` or `min`.
- This notebook's results are used to derive the plots in [result slides](https://pge-my.sharepoint.com/:p:/p/a1yu/Efnnht2p5txNpi-O25w2bWEBPmfJltoyenB-qx2n9dxbKA?e=l6E8ZD).


The above notebooks can refer to a `processed_data/` folder, which contains the datasets (e.g. yearly ILI datasets, spatial-joined datasets) saved or used by these notebooks. This folder can be accessed [here](https://pge-my.sharepoint.com/:f:/r/personal/a1yu_pge_com/Documents/Documents/code/ModelPerformance/processed_data?csf=1&web=1&e=SJktkx).

[EC_corrosion_stats](./EC_corrosion_stats.ipynb): Derives a finer-grained EC criteria based on normalized volumetric loss for selecting pipes to inspect, for the corrosion-engineering team.
- Result [slides](https://pge-my.sharepoint.com/:p:/p/a1yu/ETV7vkFkSFNDvs5Acv2F2xMBgt7cB9Vf1OKHoxTvima5jA)
- Figures generated by the notebook is in folder: [EC_wall_loss_figs](./EC_wall_loss_figs/)
- Definitions for functions used in the notebook is in [EC_corrosion_stats.py](./EC_corrosion_stats.py). This is also used in other notebooks as well.
	- Functions in this file mainly deal with data cleaning to select EC-related anomalies, and volumetric loss calculations.

## Other files:

- [utils.py](./utils.py): Common utility functions that can apply to different notebooks (mostly involving ILI so far).






